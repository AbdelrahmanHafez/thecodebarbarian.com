<html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>What's new in Mongoose 3.9.7 | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"/><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"/><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/><link href="/style/style.css" rel="stylesheet" type="text/css"/><link href="/style/github.css" rel="stylesheet" type="text/css"/><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="What's new in Mongoose 3.9.7"/><meta property="og:url" content="http://www.thecodebarbarian.com/2014/12/19/mongoose-397"/><meta property="og:image" content="//upload.wikimedia.org/wikipedia/commons/d/d9/Vosmangoesten_zoo_Lille.JPG"/><meta property="og:site_name" content="The Code Barbarian"/></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li></ul></div></div><div id="nav" class="navbar"><div class="container"><div class="navbar-header"><a href="http://thecodebarbarian.com" class="navbar-brand big-brand"><img src="/images/Barbarian_Head.png" class="logo"/><span class="site-name">The Code Barbarian</span></a></div><div id="home-nav-mobile" class="navbar-right collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/angularjs.html">AngularJS</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div id="desktop-right-bar" class="col-lg-3 col-lg-offset-9 right-bar"><div class="right-bar-content-slider pull-right"><div class="row search-container"><div class="col-lg-12"><div class="form-group"></div><label>Search</label><form onsubmit="window.location.href = 'https://www.google.im/search?q=' + encodeURIComponent(document.getElementById('searchQ').value) + '+site:thecodebarbarian.com'; return false;"><div class="input-group"><input id="searchQ" type="text" class="form-control"/><div class="input-group-addon search-button"><i class="fa fa-search"></i></div></div></form></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"/></a></div><div><script type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&amp;serve=C6AILKT&amp;placement=thecodebarbariancom" id="_carbonads_js"></script></div></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12"><p class="right-bar-label">Most Popular</p><ul class="list-unstyled"><li class="right-bar-li"><a href="http://thecodebarbarian.com/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="http://thecodebarbarian.com/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="http://thecodebarbarian.com/80-20-guide-to-async-await-in-node.js.html">The 80/20 Guide to Async/Await in Node.js</a></li><li class="right-bar-li"><a href="http://thecodebarbarian.com/getting-started-with-webassembly-in-node.js.html">Getting Started With WebAssembly in Node.js</a></li><li class="right-bar-li"><a href="http://thecodebarbarian.com/2015/01/24/angularjs-interceptors.html">An 80/20 Guide to AngularJS HTTP Interceptors</a></li></ul></div></div></div></div></div><div id="mobile-sharing-options" class="container-fluid hidden-sm hidden-md hidden-lg"><div class="row"><div class="col-lg-12"><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F2014%2F12%2F19%2Fmongoose-397&amp;via=code_barbarian" class="social"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2F2014%2F12%2F19%2Fmongoose-397" class="social"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2F2014%2F12%2F19%2Fmongoose-397" class="social"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a href="#disqus_thread" class="social"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div id="desktop-sharing-options" class="post-sharing-options hidden-xs pull-left"><ul class="list-unstyled"><li class="twitter-share"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F2014%2F12%2F19%2Fmongoose-397&amp;via=code_barbarian" class="social"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2F2014%2F12%2F19%2Fmongoose-397" class="social"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2F2014%2F12%2F19%2Fmongoose-397" class="social"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">What's new in Mongoose 3.9.7</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">December 19, 2014</span></div></div></div><div class="post-body-text-container"><p>Mongoose 3.9.7 has just been released. While I did say that 3.9.6 would be the
last release before 4.0.0-rc0, the MongoDB core server introduced a <a href="https://jira.mongodb.org/browse/SERVER-16518">minor
backwards-breaking change in 2.8.0-rc3</a>.
This threw a wrench into my plans to make Mongoose use <a href="https://github.com/mongodb/node-mongodb-native/tree/2.0">v2.0 of the MongoDB
NodeJS driver</a>, which
needs to account for the MongoDB server&#39;s change. In order to avoid having to
introduce potentially backwards-breaking changes in a release candidate,
Mongoose is postponing 4.0.0-rc0 until early 2015. Outside of upgrading to the
new version of the driver, 3.9.7 is feature-complete, and packed with some
very powerful new features.</p>
<h2 id="a-brief-aside-on-versioning-in-mongoose">A Brief Aside on Versioning in Mongoose</h2>
<p>As an aside, starting in 4.0.0, Mongoose will move to using
<a href="http://semver.org/">semantic versioning (semver)</a> rather than its current
stable/unstable versioning system. Mongoose originally used
<a href="http://en.wikipedia.org/wiki/Software_versioning#Odd-numbered_versions_for_development_releases">Linux-style
stable/unstable versioning</a>
to ensure stability and minimize the likelihood of major bugs. However,
going forward, I think semver is a better standard to ensure that mongoose
remains stable while delivering new features. The trouble with even/odd
versioning is that the unstable branch is effectively developed in a vacuum,
as developers are discouraged from using it. Thus, when the new version is
released, there are hundreds of commits in the new release that have not stood
up to production-level scrutiny (mongoose 4.0.0 is currently 420 commits ahead
of 3.8, and 3.8 was in turn 813 commits ahead of 3.6). Smaller, more focused
releases will enable mongoose to release more features faster and minimize the
amount of code change between stable releases, which in turn will lead to a
more stable project.</p>
<h2 id="on-to-the-new-features">On to the New Features</h2>
<p>Versioning rant aside, I&#39;m going to be writing a series of posts explaining
new features in Mongoose 4. In this post, I&#39;ll highlight the results of our
<a href="https://github.com/LearnBoost/mongoose/issues/2282">refactoring of Mongoose&#39;s validator system</a>. The goal of this refactoring was to enable
validators to produce <a href="https://github.com/LearnBoost/mongoose/issues/2132">richly customizable error messages</a>, for instance, enabling you to associate
an HTTP status code with a validation error. How does this work in practice?
Suppose you define a schema with a custom validator:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> breakfastSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  description: {
    type: <span class="hljs-built_in">String</span>,
    validate: [{
      validator: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{
        <span class="hljs-keyword">return</span> v.length &lt;= <span class="hljs-number">70</span>;
      },
      msg: <span class="hljs-string">'Error code: {ERRORCODE} for value "{VALUE}"'</span>,
      errorCode: <span class="hljs-number">25</span>
    }]
  }
});
</code></pre>
<p>Now, suppose you have a document with the above schema, and you set the
description to something longer than 70 characters:</p>
<pre><code class="lang-javascript">doc.description = <span class="hljs-string">''</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">7</span>; ++i) {
  doc.description += <span class="hljs-string">'6chars'</span>; <span class="hljs-comment">// total 72 characters</span>
}

doc.validate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
  <span class="hljs-comment">// error.errors['description'].toString() will equal:</span>
  <span class="hljs-comment">// 'Error code: 25 for value "6chars..."'</span>
});
</code></pre>
<p>The validator properties aren&#39;t only accessible in the message. They&#39;re also
added to the resulting error object:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// The http-status module includes a map of HTTP statuses</span>
<span class="hljs-keyword">var</span> status = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http-status'</span>);

<span class="hljs-keyword">var</span> breakfastSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  description: {
    type: <span class="hljs-built_in">String</span>,
    validate: [{
      validator: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{
        <span class="hljs-keyword">return</span> v.length &lt;= <span class="hljs-number">10</span>;
      },
      http: status.FORBIDDEN <span class="hljs-comment">// HTTP 403</span>
    }]
  }
});

<span class="hljs-comment">// ...</span>

doc.description = <span class="hljs-string">'this is longer than 10 chars'</span>;
doc.validate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
  <span class="hljs-comment">// error.errors['description'].http is equal to</span>
  <span class="hljs-comment">// status.FORBIDDEN (403)</span>
});
</code></pre>
<p>This feature is relatively small, but is exceptionally useful in allowing you
to attach custom properties to validation errors. The next post, in early
January, will cover a much larger topic: using Mongoose 4&#39;s in-browser schema
validation with AngularJS.</p>
</div><div><div class="native-js">
  <script type="text/javascript" src="/js/native.js"></script>
  <script type="text/javascript">
    _native.init('CK7DT53N', {
      targetClass: 'native-js',
      fallback: `
        <a href="#" class="native-flex">
          <style>
            .native-js {
              background: linear-gradient(-30deg, #DA3925E5, #DA3925E5 45%, #DA3925 45%) #fff;
            }
            
            .native-details {
              color: #FFFFFF !important;
            }
            
            .native-details:hover {
              color: #FFFFFF !important;
            }
            
            .native-cta {
              color: #FFFFFF;
              background-color: #626469;
            }
            
            .native-cta:hover {
              color: #native_cta_color_hover;
              background-color: #626469;
            }
          </style>
          <div class="native-main">
            <img class="native-img" src="https://cdn4.buysellads.net/uu/1/2144/1520557245-ShutterstockIcon_250x100__1_.jpg">
            <div class="native-details">
              <span class="native-company">Fallback Company</span>
              <span class="native-desc">This is a sample of using fallback ads.</span>
            </div>
          </div>
          <span class="native-cta">Fallback CTA</span>
        </a>
      `
    });
  </script>
  <a href="#native_link#" class="native-flex">
    <style>
      .native-js {
        background: linear-gradient(-30deg, #native_bg_color#E5, #native_bg_color#E5 45%, #native_bg_color# 45%) #fff;
      }
      
      .native-details {
        color: #native_color# !important;
      }
      
      .native-details:hover {
        color: #native_color_hover# !important;
      }
      
      .native-cta {
        color: #native_cta_color#;
        background-color: #native_cta_bg_color#;
      }
      
      .native-cta:hover {
        color: #native_cta_color_hover;
        background-color: #native_cta_bg_color_hover#;
      }
    </style>
    <div class="native-main">
      <img class="native-img" src="#native_logo#">
      <div class="native-details">
        <span class="native-company">#native_company#</span>
        <span class="native-desc">#native_desc#</span>
      </div>
    </div>
    <span class="native-cta">#native_cta#</span>
  </a>
</div>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/20141219_mongoose_397.md">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
  analytics.load("5DErrxzVhprg8sNh8xaiKDR6dNa7yGTI");
  analytics.page()
}}();</script><script type="text/javascript">analytics.track('opened post',
  { title: "What's new in Mongoose 3.9.7", time: new Date() });
  </script></body></html>