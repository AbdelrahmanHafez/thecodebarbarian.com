<html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Setting Up Circle CI With Node.js | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"/><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"/><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/><link href="/style/style.css" rel="stylesheet" type="text/css"/><link href="/style/github.css" rel="stylesheet" type="text/css"/><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Setting Up Circle CI With Node.js"/><meta property="og:url" content="http://www.thecodebarbarian.com/setting-up-circle-ci-with-node-js"/><meta property="og:image" content="http://i.imgur.com/3HiTMYc.jpg"/><meta property="og:site_name" content="The Code Barbarian"/></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li></ul></div></div><div id="nav" class="navbar"><div class="container"><div class="navbar-header"><a href="/" class="navbar-brand big-brand"><img src="/images/Barbarian_Head.png" class="logo"/><span class="site-name">The Code Barbarian  </span></a></div><div id="home-nav-mobile" class="navbar-right collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/angularjs.html">AngularJS</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/paleo.html">Paleo</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div id="desktop-right-bar" class="col-lg-3 col-lg-offset-9 right-bar"><div class="right-bar-content-slider pull-right"><div class="row search-container"><div class="col-lg-12"><div class="form-group"></div><label>Search</label><form onsubmit="window.location.href = 'https://www.google.im/search?q=' + encodeURIComponent(document.getElementById('searchQ').value) + '+site:thecodebarbarian.com'; return false;"><div class="input-group"><input id="searchQ" type="text" class="form-control"/><div class="input-group-addon search-button"><i class="fa fa-search"></i></div></div></form></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><div><a href="http://es2015generators.com"><img src="http://i.imgur.com/iBT2ZEw.png"/></a></div><div><a href="http://www.amazon.com/Professional-AngularJS-Valeri-Karpov/dp/1118832078/"><img src="http://i.imgur.com/NjE7AN9.png"/></a></div></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12"><p class="right-bar-label">All Time Most Popular </p><ul class="list-unstyled"><li class="right-bar-li"><a href="http://thecodebarbarian.com/2015/01/24/angularjs-interceptors">An 80/20 Guide to AngularJS HTTP Interceptors</a></li><li class="right-bar-li"><a href="http://thecodebarbarian.com/2015/01/17/angularjs-loopback">Creating REST APIs and Clients with LoopBack and AngularJS</a></li><li class="right-bar-li"><a href="http://thecodebarbarian.com/2015/02/20/better-angularjs-form-validation-with-mongoose">Better AngularJS Form Validation with Mongoose</a></li><li class="right-bar-li"><a href="http://thecodebarbarian.com/2015/02/06/static_site_generators">Static Site Generators are Overkill</a></li><li class="right-bar-li"><a href="http://thecodebarbarian.com/2015/03/06/guide-to-mongoose-plugins">An 80/20 Guide to Mongoose Plugins</a></li></ul></div></div></div></div></div><div id="mobile-sharing-options" class="container-fluid hidden-sm hidden-md hidden-lg"><div class="row"><div class="col-lg-12"><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2Fsetting-up-circle-ci-with-node-js&amp;via=code_barbarian" class="social"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fsetting-up-circle-ci-with-node-js" class="social"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fsetting-up-circle-ci-with-node-js" class="social"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a href="#disqus_thread" class="social"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div id="desktop-sharing-options" class="post-sharing-options hidden-xs pull-left"><ul class="list-unstyled"><li class="twitter-share"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2Fsetting-up-circle-ci-with-node-js&amp;via=code_barbarian" class="social"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fsetting-up-circle-ci-with-node-js" class="social"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fsetting-up-circle-ci-with-node-js" class="social"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Setting Up Circle CI With Node.js </h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">March 04, 2016</span></div></div></div><div class="post-body-text-container"><p><a href="https://circleci.com/">Circle CI</a> is quickly becoming my favorite CI tool.
Their infrastructure is pretty robust - I have yet to see a test flake out.
Plus, their UI is elegant, their config files are more expressive than Travis&#39;,
and their <a href="https://circleci.com/pricing/">free tier generously includes support for private builds for teams</a>.
I still have a soft spot in my heart for <a href="https://semaphoreci.com/">Semaphore</a>,
but I find it hard to use them because they charge extra for organizations
and they require you to configure your environment in a web UI rather than
in a YAML file. Both are leaps and bounds ahead of Travis and Shippable:
their infrastructures are flakier than a Head &amp; Shoulders commercial.</p>
<p>Here&#39;s a summary of the benefits of Circle CI over Semaphore, Travis, and
Shippable:</p>
<ul>
<li>Robust architecture (as opposed to Shippable and Travis)</li>
<li>Configure with a <code>.yml</code> file in your repo (as opposed to Semaphore)</li>
<li>Free for private repos and organizations - only pay when you want parallel builds (as opposed to Travis and Semaphore)</li>
</ul>
<p>Now that you see why Circle CI is so useful, let&#39;s take a look at how to set up
Circle CI for a Node.js project.</p>
<h2 id="adding-a-project-to-circle">Adding a Project to Circle</h2>
<p>Once you register for an account and log in, you should see an &#39;Add Projects&#39;
button on the left hand side of your Circle dashboard.</p>
<p><img src="http://i.imgur.com/bJe9DYH.png"></p>
<p>Next, choose the GitHub organization that your project is in:</p>
<p><img src="http://i.imgur.com/jErey8U.png"></p>
<p>Then choose the project you want to build and hit &quot;Build Project&quot; to trigger
your first build for this project. In this example, I&#39;ll be adding my
<a href="https://www.npmjs.com/package/dookie">MongoDB test fixture preprocessor called dookie</a>
to Circle CI. This project&#39;s test setup is not unusual for a node project -
<code>npm install</code> to install all the dependencies, start MongoDB, and run
<code>npm test</code>.</p>
<p><img src="http://i.imgur.com/qEZjtPk.png"></p>
<p>Once you hit &quot;Build Project&quot;, Circle will kick off the first build of your
project. Circle prides themselves on being able to infer the right configuration
for your project, but in my experience they always get it wrong. The
<a href="https://circleci.com/gh/vkarpov15/dookie/1">initial build of dookie</a> crashes
horribly because Circle uses node 0.10 by default and is
<a href="https://github.com/vkarpov15/dookie/blob/master/package.json">not smart enough to see <code>&quot;node&quot;: &quot;&gt;= 4.0.0&quot;</code> in the <code>package.json</code></a>.
If your initial build fails, don&#39;t worry, you can configure Circle from a
<code>.yml</code> file.</p>
<p><strong>Note:</strong> By default, Circle creates a <a href="https://developer.github.com/guides/managing-deploy-keys/">GitHub deploy key</a> for your repo.
You can think of a deploy key as an SSH key that only works for that repo.
This means that, by default, Circle only gets access to one of your repos, not
all of them.</p>
<h2 id="the-circle-yml-file">The <code>circle.yml</code> File</h2>
<p><em>TLDR; <a href="https://github.com/vkarpov15/dookie/commit/eb755a778152934bd2203d37d2c89cad4bc59b61">see a diff on GitHub</a></em></p>
<p>Putting a <code>circle.yml</code> file in your repo&#39;s root directory tells Circle how
to set up and test your project. Circle has a
<a href="https://circleci.com/docs/configuration">detailed guide to all the options available for <code>circle.yml</code></a>,
but in this article I&#39;ll highlight a few basic ones that are important for
Node.js projects.</p>
<p>The first option is the Node.js version. Circle uses Node.js 0.10 by default,
which may not be the right choice for your project. You can always tell Circle
to download node directly from <a href="http://nodejs.org">nodejs.org</a>, but Circle also
can
<a href="https://circleci.com/docs/configuration#node-version">pull the Node.js version you specify in the <code>machine.node.version</code> option</a></p>
<pre><code class="lang-yaml">machine:
  node:
    # Circle will use node v4.0.0
    version: 4.0.0
</code></pre>
<p>The <code>circle.yml</code> file is broken up into 6 &quot;sections&quot; or &quot;phases&quot;. The &quot;machine&quot;
phase is the first phase: it&#39;s responsible for setting up the core VM. There&#39;s
also a &quot;database&quot; phase. Much like Travis, Circle uses 3-year-old MongoDB 2.4
by default, which is not ideal. However, it&#39;s easy to install whichever
version of MongoDB you want in the &quot;database&quot; phase. Let&#39;s run MongoDB 3.2.3:</p>
<pre><code class="lang-yaml">database:
  # Circle will execute the below commands
  pre:
    # Stop MongoDB
    - sudo service mongodb stop
    # Download MongoDB 3.2.3
    - curl -Ol https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1204-3.2.3.tgz
    # Untar it
    - tar -zxvf mongodb-linux-x86_64-ubuntu1204-3.2.3.tgz
    # Create data directory
    - mkdir -p ./data/db
    # Fork MongoDB and log to &#39;./mongod.log&#39;. Print the log file if it failed.
    - ./mongodb-linux-x86_64-ubuntu1204-3.2.3/bin/mongod --dbpath ./data/db --logpath ./mongod.log --fork || cat ./mongod.log
</code></pre>
<p>You can also install MongoDB in the &quot;machine&quot; phase. I&#39;m not sure which
approach is more correct, but as far as I can tell these approaches are
interchangeable.</p>
<p>The most important phase is the &quot;test&quot; phase, which is where you define how
to run your repo&#39;s tests. Circle is smart enough to know to run <code>npm test</code>
for Node.js projects, but if you want to override this
(or you just want to be explicit) you can
<a href="https://circleci.com/docs/configuration#test">set the <code>test.override</code> option</a>.</p>
<pre><code class="lang-yaml">test:
  override:
    - npm test
</code></pre>
<p>You can check out the <a href="https://github.com/vkarpov15/dookie/commit/eb755a778152934bd2203d37d2c89cad4bc59b61">whole <code>circle.yml</code> for dookie on GitHub</a>.</p>
<h2 id="moving-on">Moving On</h2>
<p>Circle is an excellent CI for teams. It&#39;s robust, extensible, and fits great
with any GitHub-centric Node.js workflow. Circle is free for public as well
as private projects, so now your team has no excuse to not run tests on
every commit.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/20160304_circle_ci.md">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
  analytics.load("5DErrxzVhprg8sNh8xaiKDR6dNa7yGTI");
  analytics.page()
}}();</script><script type="text/javascript">analytics.track('opened post',
  { title: "Setting Up Circle CI With Node.js", time: new Date() });
  </script></body></html>